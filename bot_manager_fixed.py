ope[["logging.StreamHandler(sys.stdout)])\n\nclass BotInstance:\n    def __init__(self, bot_id):\n        self.bot_id = bot_id\n        self.bot_config = get_bot(bot_id)\n        self.flow_data = get_bot_flow(bot_id)\n        self.user_states = {}\n        self.running = False\n        self.thread = None\n        self.base_url = self.bot_config.get('base_url', 'https://botapi.max.ru')\n        \n        self.log('INFO', f'\u0418\u043d\u0438\u0446\u0438\u0430\u043b\u0438\u0437\u0430\u0446\u0438\u044f \u0431\u043e\u0442\u0430 {self.bot_id} ({self.bot_config[\"name"], {"H": "M:%S')"}, {"self.bot_id}": {"e}": "def get_updates(self", "marker=None)": "try:\n            url = f", "access_token": "self.bot_config['token']"}, "message}": "except Exception as e:\n            logging.error(f", "marker": "params[", "logging.debug(f": "ot {self.bot_id"}, {"logging.debug(f": "ot {self.bot_id"}, {"response.status_code}": "response.raise_for_status()\n            result = response.json()\n            updates_count = len(result.get('updates'", "logging.debug(f": "ot {self.bot_id"}, {"result}": "return result\n        except Exception as e:\n            self.log('ERROR'", "\u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u0439": {"updates": [], "marker": "None"}, "attachments=None)": "try:\n            url = f", "Content-Type": "application/json"}, {"text": "text", "format": "markdown"}, [], ["attachments"], {"self.bot_id}": "\u041e\u0442\u043f\u0440\u0430\u0432\u043b\u044f\u044e POST: {url"}, {"logging.debug(f": "ot {self.bot_id"}, {"response.status_code}": "response.raise_for_status()\n            self.log('INFO'", "chat_id}": {"update)": "if", "chat_id": "n update:\n            return update.get(", "update.get(\"message": "or {"}, "e": "self.log('ERROR'", "recipient\" in msg and isinstance(msg[\"recipient": "dict):\n            recipient = msg[", "chat_id": "n sender:\n                return sender[", "sender\" in msg and isinstance(msg[\"sender": "dict):\n            sender = msg[", "sender\" in update and isinstance(update[\"sender": "dict):\n            sender = update[", "chat\" in msg and isinstance(msg[\"chat": "dict):\n            chat = msg[", "id": "return None\n    \n    def handle_message(self", "message)": "try:\n            self.log('DEBUG'", "\u0432\u044b\u0437\u0432\u0430\u043d": {"message.get(\"chat": {}, "get(\"id": "if not chat_id:\n                chat_id = self.extract_chat_id(message)\n            \n            if not chat_id:\n                self.log('WARNING'", "\u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u044f": {"f'handle_message": "chat_id={chat_id"}, "text=": "text"}, ")\n            \n            if text == \"/start\":\n                self.log('INFO', f": "\u043e\u043b\u0443\u0447\u0435\u043d\u0430 \u043a\u043e\u043c\u0430\u043d\u0434\u0430 /start \u043e\u0442 \u0447\u0430\u0442\u0430 {chat_id"}, ["chat_id] = {'current_node': 'start', 'history': []}\n                self.show_node(chat_id, 'start')\n            else:\n                self.log('INFO', f'\u041f\u043e\u043b\u0443\u0447\u0435\u043d\u043e \u0441\u043e\u043e\u0431\u0449\u0435\u043d\u0438\u0435 \u043e\u0442 \u0447\u0430\u0442\u0430 {chat_id}:", {"text[": 50, "')\n                self.handle_text_input(chat_id, text)\n        except Exception as e:\n            self.log('ERROR', f'Error in handle_message: {e}')\n    \n    def answer_callback(self, callback_id, text=None):\n        try:\n            url = f": "self.base_url"}, "answers?access_token={self.bot_config['token']}\"\n            headers = {\"Content-Type\": \"application/json\"}\n            data = {\"callback_id\": callback_id}\n            if text:\n                data[\"text"], {"e": "self.log('ERROR'", "callback_id}": {"callback)": "callback_id = callback[", "callback.get(\"message": {}, "get(\"chat": {}, "get(\"id": "if not chat_id:\n            chat_id = self.extract_chat_id({", "message": {}, "chat_id": "self.log('WARNING'", "callback": "or {", "else": "self.send_message(chat_id", "e": "self.log('ERROR'", "node_id}": {"payload)": "if not payload.startswith('btn:'):\n            return\n        \n        button_id = payload[4:]\n        current_state = self.user_states.get(chat_id", "current_node_id": "return\n        \n        if not self.flow_data:\n            return\n        \n        current_node = next((n for n in self.flow_data.get('nodes'", "current_node": "return\n        \n        if current_node.get('buttons'):\n            button = next((b for b in current_node['buttons'] if b['id'] == button_id)", "button.get('isBack')": "if history:\n                    prev_node_id = history.pop()\n                    self.user_states[chat_id]['history'] = history\n                    self.show_node(chat_id", "else": "self.show_node(chat_id", "start')\n                return\n        \n        connection = next((c for c in self.flow_data.get('connections', []) if c['buttonId'] == button_id), None)\n        if connection and connection.get('to": "history.append(current_node_id)\n            self.user_states[chat_id]['history'] = history\n            self.show_node(chat_id", "text)": "pass\n    \n    def process_update(self", "marker)": "update_type = update.get(", "update.get(\"marker": "or marker\n        chat_id = self.extract_chat_id(update)\n        \n        self.log('DEBUG'", "\u043e\u0431\u043d\u043e\u0432\u043b\u0435\u043d\u0438\u044f": {"chat_id": {"bot_started": "if chat_id:\n                self.handle_message({", "chat": {"id": "chat_id"}, "text": "/start"}, "message_created": "msg = update.get(", "message": "or {"}, "msg.get(\"body": {}, "chat_id": "self.handle_message({", "chat": {"id": "chat_id"}, "text": "text"}, "message_callback": "cb = update.get("}, "cb.get(\"id": "if callback_id:\n                callback_struct = {", "id": "callback_id", "payload": "payload", "message": {"chat": {"id": "chat_id"}}}, "self.handle_callback(callback_struct)\n        \n        return update.get(", "marker", "marker)\n    \n    def run(self):\n        self.running = True\n        self.bot_config = get_bot(self.bot_id)\n        marker = None\n        \n        self.log('INFO'", "f'\u0411\u043e\u0442 {self.bot_config[", "name", "\u0437\u0430\u043f\u0443\u0449\u0435\u043d')\n        \n        try:\n            url = f", {"self.base_url}/me?access_token={self.bot_config['token']}": "esponse = requests.get(url", "\u041d\u0435\u0438\u0437\u0432\u0435\u0441\u0442\u043d\u044b\u0439'))\n                username = bot_info.get('username', '\u043d\u0435\u0442')\n                self.log('INFO', f": "\u043e\u0434\u043a\u043b\u044e\u0447\u0435\u043d \u043a \u0431\u043e\u0442\u0443: {bot_name"}, {"else": "self.log('WARNING'", "\u041a\u043e\u0434": {"e": "self.log('ERROR'", "\u0431\u043e\u0442\u0435": {"self.running": "try:\n                params = {"}, "None": "params[", "updates\" in updates and updates[\"updates": "for update in updates[", "updates": "marker = self.process_update(update", "marker": "time.sleep(1)\n            except Exception as e:\n                self.log('ERROR'", "\u0446\u0438\u043a\u043b\u0435": {"stopped": "except Exception as e:\n            self.log('ERROR'", "running": "return True\n            \n            self.bots[bot_id] = BotInstance(bot_id)\n            self.bots[bot_id].start()\n            return True\n        except Exception as e:\n            logging.error(f", "self.thread.is_alive()": "self.thread.join(timeout=5)\n        try:\n            update_bot_status(self.bot_id", "\u043e\u0441\u0442\u0430\u043d\u043e\u0432\u043a\u0435": {"BotManager": "def __init__(self):\n        self.bots = {"}, "bot_id)": "try:\n            if bot_id in self.bots and self.bots[bot_id].running:\n                logging.warning(f", "bot_id}": {"e}": "return False\n    \n    def stop_bot(self", "bot_id)": "try:\n            if bot_id in self.bots:\n                self.bots[bot_id].stop()\n                del self.bots[bot_id]\n                return True\n            else:\n                logging.warning(f", "stopped": "return True\n        except Exception as e:\n            logging.error(f", "bot_id}": {"e}": "return False\n    \n    def get_bot_status(self", "bot_id)": "self.stop_bot(bot_id)\n        time.sleep(1)\n        return self.start_bot(bot_id)\n\nbot_manager = BotManager()", "bot_instance.thread.is_alive()": "return", "stopped": "\u0415\u0441\u043b\u0438 \u043f\u043e\u0442\u043e\u043a \u0443\u043c\u0435\u0440", "bot_instance.running": "bot_instance.running = False\n                update_bot_status(bot_id", "stopped\")\n            return \"stopped": "ot = get_bot(bot_id)\n        return bot['status'] if bot else None\n    \n    def restart_bot(self"}}}}}]