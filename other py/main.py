# bot_buttons_only.py
# –ï–ö–°-–±–æ—Ç –Ω–∞ long-polling –ë–ï–ó –≤–µ–±—Ö—É–∫–æ–≤ –∏ –ë–ï–ó —Ç–µ–∫—Å—Ç–æ–≤–æ–≥–æ –ø–æ–∏—Å–∫–∞.
# –ù–∞–≤–∏–≥–∞—Ü–∏—è –¢–û–õ–¨–ö–û —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫–∏. –†–∞–∑–¥–µ–ª—ã —Å—Ä–∞–∑—É –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é.
import os
import time
import logging
import signal
from typing import Dict, Any, List, Optional

import requests
from dotenv import load_dotenv

load_dotenv()

API = os.getenv("BOT_API", "https://botapi.max.ru")
TOKEN = os.getenv("BOT_TOKEN")  # –æ–±—è–∑–∞—Ç–µ–ª–µ–Ω
POLL_TIMEOUT = int(os.getenv("POLL_TIMEOUT", "30"))
SLEEP_BETWEEN_ERRORS = float(os.getenv("SLEEP_BETWEEN_ERRORS", "2.5"))

if not TOKEN:
    raise SystemExit("‚ùå BOT_TOKEN –Ω–µ –∑–∞–¥–∞–Ω. –£–∫–∞–∂–∏—Ç–µ –µ–≥–æ –≤ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–∫—Ä—É–∂–µ–Ω–∏—è –∏–ª–∏ .env")

logging.basicConfig(
    level=os.getenv("LOG_LEVEL", "INFO"),
    format="%(asctime)s | %(levelname)s | %(message)s"
)
log = logging.getLogger("eks-bot")

# -----------------------------
# –ö–æ–Ω—Ç–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–µ–∫ (–¥–µ—Ç–∞–ª—å–Ω–æ —Å—Ä–∞–∑—É)
# -----------------------------
SECTIONS = {
    "about": {
        "title": "–û –∫–∞—Ä—Ç–µ",
        "text": (
            "**–ï–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∞ —Å–∞—Ö–∞–ª–∏–Ω—Ü–∞** ‚Äî —ç—Ç–æ —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –±–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞ ¬´–ú–∏—Ä¬ª —Å —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–µ–π –±–µ—Å–∫–æ–Ω—Ç–∞–∫—Ç–Ω–æ–π –æ–ø–ª–∞—Ç—ã –∏ –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º –ø–æ–ª–µ–∑–Ω—ã—Ö —Ä–µ–≥–∏–æ–Ω–∞–ª—å–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤.\n\n"
            "–° –µ—ë –ø–æ–º–æ—â—å—é –≤—ã –º–æ–∂–µ—Ç–µ:\n"
            "‚Äì –ø–æ–ª—É—á–∞—Ç—å –∑–∞—Ä–ø–ª–∞—Ç—É, –ø–µ–Ω—Å–∏–∏ –∏ —Å–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã;\n"
            "‚Äì –æ–ø–ª–∞—á–∏–≤–∞—Ç—å –ø–æ–∫—É–ø–∫–∏ –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–∫–∏–¥–∫–∞–º–∏ —É –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤;\n"
            "‚Äì –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞—Ä—Ç—É –∫–∞–∫ –ø—Ä–æ–µ–∑–¥–Ω–æ–π (–≤ —Ç–æ–º —á–∏—Å–ª–µ –ª—å–≥–æ—Ç–Ω—ã–π);\n"
            "‚Äì –ø—Ä–µ–¥—ä—è–≤–ª—è—Ç—å –µ—ë –≤ –º–µ–¥—É—á—Ä–µ–∂–¥–µ–Ω–∏—è—Ö –∫–∞–∫ –ø–æ–ª–∏—Å –û–ú–° –∏–ª–∏ –°–ù–ò–õ–°;\n"
            "‚Äì –ø–æ–ª—É—á–∞—Ç—å –≥–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–µ –∏ –º—É–Ω–∏—Ü–∏–ø–∞–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏, –∞–¥—Ä–µ—Å–Ω—É—é –ø–æ–º–æ—â—å.\n\n"
            "**–û–¥–Ω–∞ –∫–∞—Ä—Ç–∞ ‚Äî –º–Ω–æ–∂–µ—Å—Ç–≤–æ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–µ–π.**\n\n"
            "_–í—ã–ø—É—Å–∫ –∏ –æ–±—Å–ª—É–∂–∏–≤–∞–Ω–∏–µ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ (–ø–æ –ø—Ä–æ–µ–∫—Ç–Ω—ã–º —Ç–∞—Ä–∏—Ñ–∞–º –±–∞–Ω–∫–æ–≤)._"
        )
    },
    "get": {
        "title": "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å",
        "text": (
            "**–°–ø–æ—Å–æ–±—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è:**\n"
            "‚Ä¢ –û–Ω–ª–∞–π–Ω-–∑–∞—è–≤–∫–∞ –Ω–∞ –ø–æ—Ä—Ç–∞–ª–µ –ï–ö–°;\n"
            "‚Ä¢ –í –±–∞–Ω–∫–∞—Ö-–ø–∞—Ä—Ç–Ω—ë—Ä–∞—Ö (–ì–ü–ë, –í–¢–ë, –ê–¢–ë, –ò–¢–£–†–£–ü, –†–æ—Å—Å–µ–ª—å—Ö–æ–∑–±–∞–Ω–∫, –°–±–µ—Ä–±–∞–Ω–∫* ‚Äî —Å –æ—Å–æ–±—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏). "
            "–ü–æ–Ω–∞–¥–æ–±—è—Ç—Å—è –ø–∞—Å–ø–æ—Ä—Ç –∏ –°–ù–ò–õ–°.\n\n"

            "**–í–æ–∑—Ä–∞—Å—Ç –∏ –¥–µ—Ç–∏:**\n"
            "‚Ä¢ –°–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ ‚Äî —Å 14 –ª–µ—Ç;\n"
            "‚Ä¢ –î–µ—Ç—è–º ‚Äî —Å 6 –ª–µ—Ç (–≤ –ë–∞–Ω–∫–µ ¬´–ò–¢–£–†–£–ü¬ª –∏ –í–¢–ë) –∏–ª–∏ —Å 14 –ª–µ—Ç ‚Äî –≤ —Ä—è–¥–µ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–æ–≤.\n\n"

            "**–°–±–µ—Ä–±–∞–Ω–∫ ‚Äî —á—Ç–æ –≤–∞–∂–Ω–æ:**\n"
            "–ú–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –¥–µ–π—Å—Ç–≤—É—é—â—É—é –∫–∞—Ä—Ç—É ¬´–ú–∏—Ä¬ª –°–±–µ—Ä–±–∞–Ω–∫–∞ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ¬´–û—Å—Ç—Ä–æ–≤–∞.65¬ª –∏–ª–∏ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ –ï–¥–∏–Ω–æ–π –∫–∞—Ä—Ç—ã —Å–∞—Ö–∞–ª–∏–Ω—Ü–∞.\n"
            "–°–µ—Ä–≤–∏—Å—ã –ï–ö–° –∞–∫—Ç–∏–≤–∏—Ä—É—é—Ç—Å—è –≤ —Ç–µ—á–µ–Ω–∏–µ ~3 –¥–Ω–µ–π.\n\n"

            "**–ß–µ—Ä–µ–∑ –ø–æ—Ä—Ç–∞–ª –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ:**\n"
            "–ü—Ä–∏ –Ω–∞–ª–∏—á–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥—ë–Ω–Ω–æ–π —É—á—ë—Ç–Ω–æ–π –∑–∞–ø–∏—Å–∏ –Ω–∞ ¬´–ì–æ—Å—É—Å–ª—É–≥–∞—Ö¬ª –≤—ã –º–æ–∂–µ—Ç–µ –ø–æ–¥–∫–ª—é—á–∏—Ç—å –ª—é–±—É—é –∫–∞—Ä—Ç—É ¬´–ú–∏—Ä¬ª "
            "–∏–∑ —Å–ø–∏—Å–∫–∞ –±–∞–Ω–∫–æ–≤-–ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ —á–µ—Ä–µ–∑ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –Ω–∞ —Å–∞–π—Ç–µ –ï–¥–∏–Ω–æ–π –∫–∞—Ä—Ç—ã —Å–∞—Ö–∞–ª–∏–Ω—Ü–∞ "
            "–∏–ª–∏ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ö–∞—Ä—Ç–∞ —Å–∞—Ö–∞–ª–∏–Ω—Ü–∞¬ª –º–æ–±–∏–ª—å–Ω–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è ¬´–û—Å—Ç—Ä–æ–≤–∞.65¬ª.\n\n"

            "**–°—Ä–æ–∫–∏ –∏ –≤—ã–¥–∞—á–∞:**\n"
            "–°—Ä–æ–∫ –≤—ã–ø—É—Å–∫–∞ ‚Äî –¥–æ 2 –Ω–µ–¥–µ–ª—å. –ì–æ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å –≤ –±–∞–Ω–∫–µ."
        )
    },
 "benefits": {
    "title": "–õ—å–≥–æ—Ç—ã –∏ —É—Å–ª—É–≥–∏",
    "text": (
        "**–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç**\n"
        "‚Ä¢ –ï–ö–° –º–æ–∂–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–∞–∫ –ø—Ä–æ–µ–∑–¥–Ω–æ–π –±–∏–ª–µ—Ç –Ω–∞ –≥–æ—Ä–æ–¥—Å–∫–æ–º —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ.\n"
        "‚Ä¢ –†–∞–±–æ—Ç–∞–µ—Ç –∫–∞–∫ –µ–¥–∏–Ω—ã–π –∏–ª–∏ –ª—å–≥–æ—Ç–Ω—ã–π –±–∏–ª–µ—Ç ‚Äî –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –Ω–µ —Ç—Ä–µ–±—É–µ—Ç—Å—è.\n"
        "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω—ã–π –ø—Ä–æ–µ–∑–¥ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≥—Ä–∞–∂–¥–∞–Ω–∞–º 70+.\n\n"

        "**–ú–µ–¥–∏—Ü–∏–Ω–∞**\n"
        "‚Ä¢ –ö–∞—Ä—Ç–∞ –∑–∞–º–µ–Ω—è–µ—Ç –ø–æ–ª–∏—Å –û–ú–° –∏ –°–ù–ò–õ–°: –ø—Ä–µ–¥—ä—è–≤–∏—Ç–µ –ï–ö–° –ø—Ä–∏ –∑–∞–ø–∏—Å–∏ –∫ –≤—Ä–∞—á—É –∏ –ø–æ–≤—Ç–æ—Ä–Ω—ã—Ö –≤–∏–∑–∏—Ç–∞—Ö.\n\n"

        "**–°–æ—Ü–∏–∞–ª—å–Ω—ã–µ –≤—ã–ø–ª–∞—Ç—ã**\n"
        "‚Ä¢ –í—Å–µ —Å–æ—Ü–≤—ã–ø–ª–∞—Ç—ã –∑–∞—á–∏—Å–ª—è—é—Ç—Å—è –Ω–∞ –∫–∞—Ä—Ç—ã ¬´–ú–∏—Ä¬ª, –≤–∫–ª—é—á–∞—è –ï–ö–°: –ø–µ–Ω—Å–∏–∏, –ø–æ—Å–æ–±–∏—è –ø–æ —É—Ö–æ–¥—É –∑–∞ —Ä–µ–±—ë–Ω–∫–æ–º, –±–µ–∑—Ä–∞–±–æ—Ç–∏—Ü–µ, –≤—ã–ø–ª–∞—Ç—ã –Ω–∞ –¥–µ—Ç–µ–π –∏ –¥—Ä.\n"
        "‚Ä¢ –ù–∞–ø—Ä–∞–≤–∏—Ç—å –≤—ã–ø–ª–∞—Ç—ã –Ω–∞ –ï–ö–° –º–æ–∂–Ω–æ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –∫–∞—Ä—Ç—ã –≤ –±–∞–Ω–∫–µ, –ú–§–¶ –∏–ª–∏ –ü–§–†, —É–∫–∞–∑–∞–≤ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã —Å—á—ë—Ç–∞.\n\n"

        "**–°–∫–∏–¥–∫–∏ –∏ –∫–µ—à–±—ç–∫**\n"
        "‚Ä¢ –î–µ—Ä–∂–∞—Ç–µ–ª—è–º –ï–ö–° –¥–æ—Å—Ç—É–ø–Ω—ã —Å–∫–∏–¥–∫–∏ –∏ –∫–µ—à–±—ç–∫ —É –ø–∞—Ä—Ç–Ω—ë—Ä–æ–≤ –ø—Ä–æ–µ–∫—Ç–∞. –ê–∫—Ç—É–∞–ª—å–Ω—ã–µ –∞–∫—Ü–∏–∏ ‚Äî –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏ ¬´–û—Å—Ç—Ä–æ–≤–∞.65¬ª –∏ –Ω–∞ —Å–∞–π—Ç–µ –≤ —Ä–∞–∑–¥–µ–ª–µ ¬´–ü–∞—Ä—Ç–Ω–µ—Ä—ã¬ª.\n\n"

        "**–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π —Å–æ—Ü—Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç (–ø—Ä–æ–¥—É–∫—Ç—ã)**\n"
        "‚Ä¢ –ú–∞–ª–æ–∏–º—É—â–∏–µ —Å–µ–º—å–∏ —Å –¥–µ—Ç—å–º–∏ –ø–æ–ª—É—á–∞—é—Ç –ø–æ–º–æ—â—å –≤ –≤–∏–¥–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–∞ (1 –±–∞–ª–ª = 1 ‚ÇΩ):\n"
        "  ‚Äî 1 900 ‚ÇΩ ‚Äî —é–≥ –∏ —Ü–µ–Ω—Ç—Ä –°–∞—Ö–∞–ª–∏–Ω–∞;\n"
        "  ‚Äî 2 050 ‚ÇΩ ‚Äî –û—Ö–∞, –ù–æ–≥–ª–∏–∫–∏, –ö—É—Ä–∏–ª—ã.\n"
        "‚Ä¢ –û–ø–ª–∞—Ç–∞ –Ω–∞ –∫–∞—Å—Å–µ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç–æ–º; –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ —Å—É–º–º—ã ‚Äî –¥–æ–ø–ª–∞—Ç–∞ —Å–≤–æ–∏–º–∏ —Å—Ä–µ–¥—Å—Ç–≤–∞–º–∏.\n\n"

        "**–ê–∫–≤–∞–ø–∞—Ä–∫**\n"
        "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –¥–ª—è –≥—Ä–∞–∂–¥–∞–Ω 55+ –∏ –¥–µ—Ç–µ–π 7‚Äì17 –ª–µ—Ç (–æ–±—É—á–∞—é—â–∏—Ö—Å—è –≤ —à–∫–æ–ª–∞—Ö –°–∞—Ö–∞–ª–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏).\n"
        "‚Ä¢ –¢–∞–∫–∂–µ ‚Äî –¥–ª—è —Ä–æ–¥–∏—Ç–µ–ª–µ–π (–æ–ø–µ–∫—É–Ω—ã, –ø–æ–ø–µ—á–∏—Ç–µ–ª–∏) –¥–µ—Ç–µ–π, –µ—Å–ª–∏ –¥—Ä—É–≥–æ–π —Ä–æ–¥–∏—Ç–µ–ª—å –ø—Ä–æ—Ö–æ–¥–∏—Ç –≤–æ–µ–Ω–Ω—É—é —Å–ª—É–∂–±—É –∏ —É—á–∞—Å—Ç–≤—É–µ—Ç –≤ –°–í–û.\n"
        "‚Ä¢ –ü—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ –∫–∞—Ä—Ç—ã —É —Ä–µ–±—ë–Ω–∫–∞ –º–æ–∂–Ω–æ –ø—Ä–∏–≤—è–∑–∞—Ç—å –µ–≥–æ –∫ –ï–ö–° —Ä–æ–¥–∏—Ç–µ–ª—è –∏–ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç –Ω–∞ [msz.sakhalin.gov.ru](https://msz.sakhalin.gov.ru).\n\n"

        "**–°–∫–∏-–ø–∞—Å—Å ¬´–ì–æ—Ä–Ω—ã–π –≤–æ–∑–¥—É—Ö¬ª**\n"
        "‚Ä¢ 55+ ‚Äî —Ç–∞—Ä–∏—Ñ ¬´–°–∞—Ö–∞–ª–∏–Ω—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ. –ë–µ–∑–ª–∏–º–∏—Ç 3 —á–∞—Å–∞¬ª (–ø–µ—Ä–≤–∞—è –∫–∞—Ä—Ç–∞ ‚Äî –±–µ—Å–ø–ª–∞—Ç–Ω–æ).\n"
        "‚Ä¢ –û—Å—Ç–∞–ª—å–Ω—ã–µ –¥–µ—Ä–∂–∞—Ç–µ–ª–∏ ‚Äî —Å–∫–∏–¥–∫–∞ 10% –Ω–∞ —Ä—è–¥ —Ç–∞—Ä–∏—Ñ–æ–≤ –ø—Ä–∏ –æ–ø–ª–∞—Ç–µ –ï–ö–°.\n\n"

        "**–°–∞—Ö–∞–ª–∏–Ω—Å–∫–æ–µ –¥–æ–ª–≥–æ–ª–µ—Ç–∏–µ**\n"
        "‚Ä¢ –ë–µ—Å–ø–ª–∞—Ç–Ω–æ–µ –ø–æ—Å–µ—â–µ–Ω–∏–µ –∫–∏–Ω–æ, —Ç–µ–∞—Ç—Ä–æ–≤, –±–∞—Å—Å–µ–π–Ω–æ–≤, —Å–ø–æ—Ä—Ç–∑–∞–ª–æ–≤ –∏ –¥—Ä. ‚Äî –¥–æ 20 –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π –≤ –º–µ—Å—è—Ü."
    )
},
    "faq": {
        "title": "–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã",
        "text": (
            "**–ö–∞–∫–∏–µ –±–∞–Ω–∫–∏ –æ—Ñ–æ—Ä–º–ª—è—é—Ç –ï–ö–°?**\n"
            "–ê–¢–ë, –ò–¢–£–†–£–ü, –ì–∞–∑–ø—Ä–æ–º–±–∞–Ω–∫, –†–æ—Å—Å–µ–ª—å—Ö–æ–∑–±–∞–Ω–∫, –í–¢–ë –∏ –°–±–µ—Ä–±–∞–Ω–∫* (—Å –æ—Å–æ–±—ã–º–∏ —É—Å–ª–æ–≤–∏—è–º–∏).\n\n"

            "**–ú–æ–∂–Ω–æ –ª–∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∫–∞—Ä—Ç—É —Ä–µ–±—ë–Ω–∫—É?**\n"
            "–î–∞. –° 6 –ª–µ—Ç ‚Äî –≤ –±–∞–Ω–∫–∞—Ö ¬´–ò–¢–£–†–£–ü¬ª –∏ –í–¢–ë, —Å 14 –ª–µ—Ç ‚Äî –≤ –¥—Ä—É–≥–∏—Ö –±–∞–Ω–∫–∞—Ö-–ø–∞—Ä—Ç–Ω—ë—Ä–∞—Ö.\n\n"

            "**–°–∫–æ–ª—å–∫–æ –∏–∑–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –∫–∞—Ä—Ç–∞ –∏ –≥–¥–µ –µ—ë –ø–æ–ª—É—á–∏—Ç—å?**\n"
            "–°—Ä–æ–∫ –≤—ã–ø—É—Å–∫–∞ ‚Äî –¥–æ 2 –Ω–µ–¥–µ–ª—å. –ì–æ—Ç–æ–≤—É—é –∫–∞—Ä—Ç—É –º–æ–∂–Ω–æ –∑–∞–±—Ä–∞—Ç—å –≤ –±–∞–Ω–∫–µ.\n\n"

            "‚ÑπÔ∏è –° –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—ã–º–∏ –æ—Ç–≤–µ—Ç–∞–º–∏ –º–æ–∂–Ω–æ –æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è –≤ —Ä–∞–∑–¥–µ–ª–µ "
            "[¬´–ß–∞—Å—Ç–æ –∑–∞–¥–∞–≤–∞–µ–º—ã–µ –≤–æ–ø—Ä–æ—Å—ã¬ª](https://eks.sakhalin.gov.ru/support/#chavo) "
            "–Ω–∞ –æ—Ñ–∏—Ü–∏–∞–ª—å–Ω–æ–º —Å–∞–π—Ç–µ –ø—Ä–æ–µ–∫—Ç–∞."
        )
    },
    "contacts": {
        "title": "–ö–æ–Ω—Ç–∞–∫—Ç—ã",
        "text": (
            "**–ó–∞—è–≤–∫–∏ –∏ –∫–æ–Ω—Å—É–ª—å—Ç–∞—Ü–∏–∏ –ø–æ –ï–ö–°:**\n"
            "üìû +7 (4242) 70-60-30\n\n"
            "**–ì–æ—Ä—è—á–∞—è –ª–∏–Ω–∏—è –ú–∏–Ω—Å–æ—Ü–∑–∞—â–∏—Ç—ã:**\n"
            "‚òéÔ∏è 8-800-201-00-99\n\n"
            "**–û—Ñ–∏—Ü–∏–∞–ª—å–Ω—ã–π —Å–∞–π—Ç:**\n"
            "üåê [eks.sakhalin.gov.ru](https://eks.sakhalin.gov.ru)"
        )
    }
}

WELCOME_TEXT = (
    "–ü—Ä–∏–≤–µ—Ç! –Ø –±–æ—Ç **–ï–ö–°.**\n"
    "–ü–æ–º–æ–≥–∞—é –∂–∏—Ç–µ–ª—è–º –°–∞—Ö–∞–ª–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏ –ø–æ–Ω—è—Ç—å, —á—Ç–æ –¥–∞—ë—Ç –ï–¥–∏–Ω–∞—è –∫–∞—Ä—Ç–∞ –∂–∏—Ç–µ–ª—è –°–∞—Ö–∞–ª–∏–Ω—Å–∫–æ–π –æ–±–ª–∞—Å—Ç–∏, –≥–¥–µ –∏ –∫–∞–∫ –µ—ë –æ—Ñ–æ—Ä–º–∏—Ç—å, "
    "–∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ, –º–µ–¥–∏—Ü–∏–Ω–µ –∏ —Å–æ—Ü–ø–æ–¥–¥–µ—Ä–∂–∫–µ, –∫–∞–∫–∏–µ –µ—Å—Ç—å —Å–∫–∏–¥–∫–∏ –∏ —Å–µ—Ä—Ç–∏—Ñ–∏–∫–∞—Ç—ã."
)

# -----------------------------
# HTTP helpers
# -----------------------------
def _url(path: str, **qs) -> str:
    params = "&".join([f"{k}={requests.utils.quote(str(v))}" for k, v in qs.items() if v is not None])
    return f"{API}{path}?access_token={requests.utils.quote(TOKEN)}" + (f"&{params}" if params else "")

def http_post(path: str, body: Dict[str, Any], **qs) -> Dict[str, Any]:
    url = _url(path, **qs)
    r = requests.post(url, json=body, timeout=30)
    r.raise_for_status()
    return r.json() if r.text else {}

def http_get(path: str, **qs) -> Dict[str, Any]:
    url = _url(path, **qs)
    r = requests.get(url, timeout=30)
    r.raise_for_status()
    return r.json() if r.text else {}

# -----------------------------
# –°–æ–æ–±—â–µ–Ω–∏—è –∏ –∫–ª–∞–≤–∏–∞—Ç—É—Ä—ã
# -----------------------------
def main_menu_keyboard() -> Dict[str, Any]:
    # –ë–µ–∑ –Ω—É–º–µ—Ä–∞—Ü–∏–∏ ‚Äî —á–∏—Å—Ç—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è
    return {
        "type": "inline_keyboard",
        "payload": {
            "buttons": [
                [
                    {"type": "callback", "text": "–û –∫–∞—Ä—Ç–µ", "payload": "sect:about"},
                    {"type": "callback", "text": "–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å", "payload": "sect:get"}
                ],
                [
                    {"type": "callback", "text": "–õ—å–≥–æ—Ç—ã –∏ —É—Å–ª—É–≥–∏", "payload": "sect:benefits"}
                ],
                [
                    {"type": "callback", "text": "–ß–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã", "payload": "sect:faq"},
                    {"type": "callback", "text": "–ö–æ–Ω—Ç–∞–∫—Ç—ã", "payload": "sect:contacts"}
                ]
            ]
        }
    }

def reply_menu_button() -> Dict[str, Any]:
    # –ü–æ—Å—Ç–æ—è–Ω–Ω–∞—è reply-–∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ —Å –æ–¥–Ω–æ–π –∫–Ω–æ–ø–∫–æ–π ¬´–ú–µ–Ω—é¬ª (—Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏ —ç—Ç–æ —Ç–µ–∫—Å—Ç, –Ω–æ —ç—Ç–æ –∏–º–µ–Ω–Ω–æ –∫–Ω–æ–ø–∫–∞)
    return {"type": "reply_keyboard", "buttons": [[{"type": "message", "text": "–ú–µ–Ω—é"}]]}

def build_main_screen_message() -> Dict[str, Any]:
    # –ì–ª–∞–≤–Ω–∞—è: –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ + –∫—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ + –º–µ–Ω—é.
    return {
        "text": f"{WELCOME_TEXT}\n\n–í—ã –º–æ–∂–µ—Ç–µ –≤–æ—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —Å–ª–µ–¥—É—é—â–∏–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏:",
        "format": "markdown",
        "attachments": [main_menu_keyboard(), reply_menu_button()]
    }

def build_section_message(section_key: str) -> Dict[str, Any]:
    sec = SECTIONS[section_key]
    text = f"**{sec['title']}**\n{sec['text']}"
    return {
        "text": text,
        "format": "markdown",
        "attachments": [{
            "type": "inline_keyboard",
            "payload": {"buttons": [[{"type": "callback", "text": "–ù–∞–∑–∞–¥ –≤ –º–µ–Ω—é", "payload": "sect:menu"}]]}
        }, reply_menu_button()]
    }

def send_main_screen(chat_id: int):
    http_post("/messages", build_main_screen_message(), chat_id=chat_id)

def answer_callback(callback_id: str, message_body: Optional[Dict[str, Any]] = None, toast: Optional[str] = None):
    payload: Dict[str, Any] = {}
    if message_body:
        payload["message"] = message_body
    if toast:
        payload["toast"] = {"text": toast}
    http_post("/answers", payload, callback_id=callback_id)

# -----------------------------
# Long polling loop
# -----------------------------
stop_flag = False

def handle_sigterm(signum, frame):
    global stop_flag
    stop_flag = True
    log.info("–ü–æ–ª—É—á–µ–Ω —Å–∏–≥–Ω–∞–ª –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è, –≤—ã—Ö–æ–¥–∏–º...")

signal.signal(signal.SIGINT, handle_sigterm)
signal.signal(signal.SIGTERM, handle_sigterm)

def extract_chat_id(u: Dict[str, Any]) -> Optional[int]:
    if "chat_id" in u:
        return u.get("chat_id")
    msg = u.get("message") or {}
    if "recipient" in msg and isinstance(msg["recipient"], dict):
        return msg["recipient"].get("chat_id")
    if "sender" in msg and isinstance(msg["sender"], dict):
        return msg["sender"].get("chat_id")
    return None

def process_update(u: Dict[str, Any], marker: Optional[str]) -> Optional[str]:
    update_type = u.get("update_type") or u.get("type")
    new_marker = u.get("marker") or marker
    chat_id = extract_chat_id(u)

    if update_type == "bot_started":
        if chat_id:
            send_main_screen(chat_id)

    elif update_type == "message_created":
        # –ù–∞–≤–∏–≥–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –ø–æ –∫–Ω–æ–ø–∫–∞–º, –ù–û reply-–∫–Ω–æ–ø–∫–∞ ¬´–ú–µ–Ω—é¬ª –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ç–µ–∫—Å—Ç "–ú–µ–Ω—é" ‚Äî —ç—Ç–æ –¥–æ–ø—É—Å—Ç–∏–º–æ.
        msg = u.get("message") or {}
        text = (msg.get("body", {}).get("text") or "").strip().lower()
        if chat_id and text in ("–º–µ–Ω—é", "/start", "start", "/menu"):
            send_main_screen(chat_id)
        # –ò–Ω–∞—á–µ –∏–≥–Ω–æ—Ä–∏—Ä—É–µ–º —Å–≤–æ–±–æ–¥–Ω—ã–π –≤–≤–æ–¥ (–Ω–∏–∫–∞–∫–∏—Ö –ø–æ–¥—Å–∫–∞–∑–æ–∫/–ø–æ–∏—Å–∫–∞).

    elif update_type == "message_callback":
        cb = u.get("callback") or {}
        payload = cb.get("payload") or ""
        callback_id = cb.get("callback_id") or cb.get("id")
        if not callback_id:
            return new_marker
        handle_callback(payload, callback_id)

    return new_marker

def handle_callback(payload: str, callback_id: str):
    # –†–∞–∑—Ä–µ—à–µ–Ω—ã —Ç–æ–ª—å–∫–æ: sect:about|get|benefits|faq|contacts|menu
    try:
        if not payload.startswith("sect:"):
            answer_callback(callback_id, None, toast="–ö–æ–º–∞–Ω–¥–∞ –Ω–µ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞")
            return

        _, key = payload.split(":", 1)
        if key == "menu":
            # –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ü–û–õ–ù–£–Æ –≥–ª–∞–≤–Ω—É—é (–∫–∞–∫ –≤ –ø–µ—Ä–≤—ã–π —Ä–∞–∑)
            answer_callback(callback_id, build_main_screen_message())
            return

        if key in SECTIONS:
            answer_callback(callback_id, build_section_message(key))
            return

        answer_callback(callback_id, None, toast="–†–∞–∑–¥–µ–ª –Ω–µ –Ω–∞–π–¥–µ–Ω")
    except Exception:
        log.exception("–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ callback")
        answer_callback(callback_id, None, toast="–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞")

def poll_updates():
    marker = None
    log.info("–°—Ç–∞—Ä—Ç long-polling (timeout=%ss)...", POLL_TIMEOUT)
    while not stop_flag:
        try:
            params = {"timeout": POLL_TIMEOUT}
            if marker:
                params["marker"] = marker
            data = http_get("/updates", **params)

            updates: List[Dict[str, Any]] = data.get("updates") or data.get("result") or data.get("data") or []
            if isinstance(updates, dict):
                updates = [updates]
            if not updates:
                continue

            for u in updates:
                marker = process_update(u, marker) or marker

        except requests.Timeout:
            continue
        except KeyboardInterrupt:
            break
        except Exception as e:
            log.exception("Polling error: %s", e)
            time.sleep(SLEEP_BETWEEN_ERRORS)

    log.info("–û—Å—Ç–∞–Ω–æ–≤–∫–∞ long-polling")

# -----------------------------
# Entry point
# -----------------------------
if __name__ == "__main__":
    try:
        poll_updates()
    except KeyboardInterrupt:
        pass
